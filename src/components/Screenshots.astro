---
const dashboardSlides = [
  { src: '/images/portfolio-overview.png', alt: 'Portfolio overview with total value, donut chart, and history graph', caption: 'Portfolio Overview' },
  { src: '/images/all-assets-overview.png', alt: 'All assets overview with prices, holdings, and 24h changes', caption: 'All Assets Overview' },
  { src: '/images/manage-wallets.png', alt: 'Manage wallets view with multi-chain wallet list and token counts', caption: 'Manage Wallets' },
  { src: '/images/defi-positions.png', alt: 'DeFi staked positions and stablecoins across multiple protocols', caption: 'DeFi Positions' },
  { src: '/images/cardano-asset-breakdown.png', alt: 'Cardano asset breakdown modal with allocation donut chart', caption: 'Asset Breakdown' },
  { src: '/images/analytics-allocation.png', alt: 'Data and analytics with allocation donuts and price chart', caption: 'Analytics & Allocation' },
  { src: '/images/wallet-intelligence.png', alt: 'Wallet intelligence with on-chain activity scoring and insights', caption: 'Wallet Intelligence' },
  { src: '/images/portfolio-vs-btc.png', alt: 'Portfolio performance benchmarked against Bitcoin over time', caption: 'Portfolio vs BTC' },
  { src: '/images/relative-strength.png', alt: 'Relative strength comparison across portfolio assets', caption: 'Relative Strength' },
  { src: '/images/crypto-market.png', alt: 'Crypto market overview with top movers and global stats', caption: 'Crypto Market' },
  { src: '/images/chains-by-tvl.png', alt: 'Blockchain rankings sorted by total value locked', caption: 'Chains by TVL' },
  { src: '/images/portfolio-heatmap.png', alt: 'Portfolio heatmap showing asset sizes and performance', caption: 'Portfolio Heatmap' },
  { src: '/images/transaction-history.png', alt: 'Transaction history with filters across all chains', caption: 'Transaction History' },
  { src: '/images/manage-apis.png', alt: 'API management dashboard with utilization and configuration', caption: 'API Management' },
  { src: '/images/backend-services.png', alt: 'Backend services status showing FastAPI, database, and external APIs', caption: 'Backend Services' },
];

const mobileSlides = [
  { src: '/images/mobile-portfolio.jpeg', alt: 'iOS app portfolio overview with total value and asset list', caption: 'Portfolio' },
  { src: '/images/mobile-holdings.jpeg', alt: 'iOS app all holdings view with prices and allocations', caption: 'All Holdings' },
  { src: '/images/mobile-wallets.jpeg', alt: 'iOS app wallet management with multi-chain wallets', caption: 'Wallets' },
  { src: '/images/mobile-nfts.jpeg', alt: 'iOS app NFT gallery with collection grid', caption: 'NFT Gallery' },
  { src: '/images/mobile-eth-detail.jpeg', alt: 'iOS app Ethereum detail view with price chart', caption: 'ETH Detail' },
];

const watchSlides = [
  { src: '/images/watch-portfolio.png', alt: 'watchOS app portfolio overview with total value', caption: 'Portfolio' },
  { src: '/images/watch-assets.png', alt: 'watchOS app top assets list with prices', caption: 'Assets' },
  { src: '/images/watch-btc-detail.png', alt: 'watchOS app Bitcoin detail with price chart', caption: 'BTC Detail' },
];

const tabs = [
  { id: 'dashboard', label: 'Dashboard', slides: dashboardSlides },
  { id: 'mobile', label: 'Mobile', slides: mobileSlides },
  { id: 'watchos', label: 'watchOS', slides: watchSlides },
];
---

<section class="section screenshots" id="screenshots">
  <div class="container">
    <h2 class="section-title">See It in Action</h2>
    <p class="section-subtitle">
      Track your portfolio across dashboard, mobile, and watch â€” all powered by your self-hosted ABCT instance.
    </p>

    <div class="tabs">
      {tabs.map((tab, i) => (
        <button
          class:list={['tab-btn', { active: i === 0 }]}
          data-tab={tab.id}
        >
          {tab.label}
        </button>
      ))}
    </div>
  </div>

  {tabs.map((tab, i) => (
    <div
      class:list={['tab-panel', { active: i === 0 }]}
      data-panel={tab.id}
    >
      <div class="slider">
        <button class="slider-arrow slider-arrow--prev" data-arrow="prev" aria-label="Previous screenshot">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
            <path d="M15 18L9 12L15 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>

        <div class="slider-viewport" data-viewport>
          {tab.slides.map((slide, j) => (
            <div class:list={['slide', `slide--${tab.id}`]}>
              <div class:list={['slide-img', `slide-img--${tab.id}`]}>
                <img
                  src={slide.src}
                  alt={slide.alt}
                  loading={i === 0 && j < 2 ? 'eager' : 'lazy'}
                  decoding="async"
                />
              </div>
              <p class="slide-caption">{slide.caption}</p>
            </div>
          ))}
        </div>

        <button class="slider-arrow slider-arrow--next" data-arrow="next" aria-label="Next screenshot">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
            <path d="M9 6L15 12L9 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
      </div>

      <div class="slider-dots" data-dots>
        {tab.slides.map((s, j) => (
          <button
            class:list={['dot', { active: j === 0 }]}
            data-index={j}
            aria-label={`View ${s.caption}`}
          />
        ))}
      </div>
    </div>
  ))}
</section>

<style>
  .screenshots {
    background: var(--bg-secondary);
  }

  /* Tabs */
  .tabs {
    display: flex;
    justify-content: center;
    gap: 8px;
    margin-bottom: 36px;
  }

  .tab-btn {
    padding: 10px 24px;
    border-radius: 100px;
    border: 1px solid var(--border);
    background: transparent;
    color: var(--text-secondary);
    font-size: 0.95rem;
    font-weight: 600;
    cursor: pointer;
    transition: all var(--transition);
  }

  .tab-btn:hover {
    border-color: var(--accent);
    color: var(--accent);
  }

  .tab-btn.active {
    background: rgba(0, 210, 106, 0.12);
    border-color: var(--accent);
    color: var(--accent);
  }

  /* Tab panels */
  .tab-panel {
    display: none;
  }

  .tab-panel.active {
    display: block;
  }

  /* Slider shell */
  .slider {
    position: relative;
    display: flex;
    align-items: center;
    max-width: 1400px;
    margin: 0 auto;
    padding: 0 60px;
  }

  /* Scroll-snap viewport */
  .slider-viewport {
    display: flex;
    gap: 32px;
    overflow-x: auto;
    scroll-snap-type: x mandatory;
    scroll-behavior: smooth;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: none;
    padding: 20px 0;
  }

  .slider-viewport::-webkit-scrollbar {
    display: none;
  }

  /* Slide variants */
  .slide {
    scroll-snap-align: center;
    display: flex;
    flex-direction: column;
    gap: 14px;
  }

  .slide--dashboard {
    flex: 0 0 min(600px, 80vw);
  }

  .slide--mobile {
    flex: 0 0 min(280px, 60vw);
  }

  .slide--watchos {
    flex: 0 0 min(220px, 45vw);
  }

  .slide-img {
    border-radius: 14px;
    overflow: hidden;
    border: 1px solid var(--border);
    box-shadow: 0 12px 40px rgba(0, 0, 0, 0.35);
    transition: border-color var(--transition), box-shadow var(--transition);
  }

  .slide-img:hover {
    border-color: var(--border-accent);
    box-shadow: 0 16px 50px rgba(0, 0, 0, 0.45), 0 0 24px var(--accent-glow);
  }

  .slide-img--mobile {
    border-radius: 24px;
  }

  .slide-img--watchos {
    border-radius: 50px;
  }

  .slide-img img {
    width: 100%;
    height: auto;
    display: block;
  }

  .slide-caption {
    text-align: center;
    font-size: 0.95rem;
    font-weight: 600;
    color: var(--text-muted);
  }

  /* Arrows */
  .slider-arrow {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    z-index: 2;
    width: 48px;
    height: 48px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    border: 1px solid var(--border);
    background: rgba(26, 26, 46, 0.85);
    backdrop-filter: blur(12px);
    color: var(--text-secondary);
    cursor: pointer;
    transition: border-color var(--transition), color var(--transition), background var(--transition);
  }

  .slider-arrow:hover {
    border-color: var(--accent);
    color: var(--accent);
    background: rgba(0, 210, 106, 0.1);
  }

  .slider-arrow--prev { left: 4px; }
  .slider-arrow--next { right: 4px; }

  /* Dots */
  .slider-dots {
    display: flex;
    justify-content: center;
    gap: 10px;
    margin-top: 28px;
  }

  .dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    border: none;
    padding: 0;
    background: var(--text-muted);
    opacity: 0.35;
    cursor: pointer;
    transition: background var(--transition), opacity var(--transition), transform var(--transition);
  }

  .dot.active {
    background: var(--accent);
    opacity: 1;
    transform: scale(1.3);
  }

  .dot:hover {
    opacity: 0.7;
  }

  /* Responsive */
  @media (max-width: 768px) {
    .slider {
      padding: 0 12px;
    }

    .slider-viewport {
      gap: 20px;
    }

    .slide--dashboard {
      flex: 0 0 85vw;
    }

    .slide--mobile {
      flex: 0 0 70vw;
    }

    .slide--watchos {
      flex: 0 0 55vw;
    }

    .slider-arrow {
      display: none;
    }

    .slider-dots {
      margin-top: 20px;
    }

    .tabs {
      gap: 6px;
    }

    .tab-btn {
      padding: 8px 18px;
      font-size: 0.88rem;
    }
  }
</style>

<script>
  function initPanel(panel: HTMLElement) {
    const viewport = panel.querySelector('[data-viewport]') as HTMLElement;
    const dots = panel.querySelectorAll<HTMLButtonElement>('.dot');
    const prevBtn = panel.querySelector('[data-arrow="prev"]');
    const nextBtn = panel.querySelector('[data-arrow="next"]');

    if (!viewport) return;

    const slides = viewport.querySelectorAll<HTMLElement>('.slide');

    function scrollToSlide(index: number) {
      const target = slides[index];
      if (!target) return;
      const offset = target.offsetLeft - viewport.offsetLeft
        - (viewport.clientWidth - target.clientWidth) / 2;
      viewport.scrollTo({ left: offset, behavior: 'smooth' });
    }

    function updateDots() {
      const center = viewport.scrollLeft + viewport.clientWidth / 2;
      let closest = 0;
      let minDist = Infinity;
      slides.forEach((slide, i) => {
        const slideCenter = slide.offsetLeft - viewport.offsetLeft + slide.clientWidth / 2;
        const dist = Math.abs(center - slideCenter);
        if (dist < minDist) { minDist = dist; closest = i; }
      });
      dots.forEach((d, i) => d.classList.toggle('active', i === closest));
    }

    let scrollTimeout: ReturnType<typeof setTimeout>;
    viewport.addEventListener('scroll', () => {
      clearTimeout(scrollTimeout);
      scrollTimeout = setTimeout(updateDots, 60);
    }, { passive: true });

    prevBtn?.addEventListener('click', () => {
      const active = [...dots].findIndex(d => d.classList.contains('active'));
      if (active > 0) scrollToSlide(active - 1);
    });

    nextBtn?.addEventListener('click', () => {
      const active = [...dots].findIndex(d => d.classList.contains('active'));
      if (active < slides.length - 1) scrollToSlide(active + 1);
    });

    dots.forEach(dot => {
      dot.addEventListener('click', () => {
        const idx = parseInt(dot.dataset.index || '0');
        scrollToSlide(idx);
      });
    });
  }

  // Tab switching
  const tabBtns = document.querySelectorAll<HTMLButtonElement>('.tab-btn');
  const panels = document.querySelectorAll<HTMLElement>('.tab-panel');
  const initialized = new Set<string>();

  // Init first panel immediately
  const firstPanel = document.querySelector<HTMLElement>('.tab-panel.active');
  if (firstPanel) {
    initPanel(firstPanel);
    initialized.add(firstPanel.dataset.panel || '');
  }

  tabBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      const tabId = btn.dataset.tab || '';

      tabBtns.forEach(b => b.classList.toggle('active', b === btn));
      panels.forEach(p => p.classList.toggle('active', p.dataset.panel === tabId));

      // Lazy-init carousel on first view
      if (!initialized.has(tabId)) {
        const panel = document.querySelector<HTMLElement>(`[data-panel="${tabId}"]`);
        if (panel) {
          initPanel(panel);
          initialized.add(tabId);
        }
      }
    });
  });
</script>
